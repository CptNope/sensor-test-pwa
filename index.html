<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Sensor Test PWA</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body { font-family: sans-serif; padding:1rem; }
    .sensor { margin-bottom:1rem; }
    button { margin-right: 0.5rem; }
    .status { font-weight: bold; }
    #install-container {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
    }
    #btn-install {
      display: none;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border: none;
      background: #3367D6;
      color: white;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <h1>Sensor Test</h1>

  <div id="accelerometer" class="sensor">
    <h2>Accelerometer</h2>
    <div>Status: <span class="status">—</span></div>
    <div>Reading: <span class="reading">—</span></div>
    <button class="btn-request">Enable</button>
  </div>

  <div id="gyroscope" class="sensor">
    <h2>Gyroscope</h2>
    <div>Status: <span class="status">—</span></div>
    <div>Reading: <span class="reading">—</span></div>
    <button class="btn-request">Enable</button>
  </div>

  <!-- Install button container -->
  <div id="install-container">
    <button id="btn-install">Install App</button>
  </div>

  <script>
  // helper to update UI
  function update(elem, { status, reading }) {
    if (status !== undefined) elem.querySelector('.status').textContent = status;
    if (reading !== undefined) elem.querySelector('.reading').textContent = reading;
  }

  // generic sensor setup
  async function setupSensor(sensorName, SensorConstructor, eventNameFallback) {
    const container = document.getElementById(sensorName);
    const btn = container.querySelector('.btn-request');

    // feature-detect
    const hasGeneric = SensorConstructor in window;
    const hasFallback = eventNameFallback in window;

    update(container, {
      status: hasGeneric || hasFallback ? 'Supported' : 'Not supported'
    });
    if (!hasGeneric && !hasFallback) {
      btn.disabled = true;
      return;
    }

    btn.addEventListener('click', async () => {
      btn.disabled = true;
      try {
        // Permissions API (optional)
        if (navigator.permissions && hasGeneric) {
          const perm = await navigator.permissions.query({ name: sensorName });
          if (perm.state === 'denied') {
            update(container, { status: 'Permission denied' });
            return;
          }
        }

        if (hasGeneric) {
          // Generic Sensor API
          const sensor = new window[SensorConstructor]();
          sensor.addEventListener('reading', () => {
            const vals = [sensor.x, sensor.y, sensor.z].map(n => n.toFixed(2)).join(', ');
            update(container, { status: 'Working', reading: vals });
          });
          sensor.start();
        } else {
          // Fallback: DeviceMotionEvent or DeviceOrientationEvent
          window.addEventListener(eventNameFallback, ev => {
            let vals;
            if (eventNameFallback === 'devicemotion') {
              vals = [ev.acceleration.x, ev.acceleration.y, ev.acceleration.z]
                .map(n => n ? n.toFixed(2) : '0.00').join(', ');
            } else {
              vals = [ev.alpha, ev.beta, ev.gamma]
                .map(n => n.toFixed(2)).join(', ');
            }
            update(container, { status: 'Working (fallback)', reading: vals });
          }, { once: true });
          update(container, { status: 'Working (fallback)' });
        }
      } catch (err) {
        update(container, { status: 'Error' });
        console.error(err);
      }
    });
  }

  // PWA install prompt handling
  let deferredPrompt;
  const installBtn = document.getElementById('btn-install');

  window.addEventListener('beforeinstallprompt', e => {
    // Prevent the mini-infobar from appearing on mobile
    e.preventDefault();
    deferredPrompt = e;
    installBtn.style.display = 'inline-block';
  });

  installBtn.addEventListener('click', async () => {
    installBtn.disabled = true;
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    const choice = await deferredPrompt.userChoice;
    console.log('Install outcome:', choice.outcome);
    deferredPrompt = null;
    installBtn.style.display = 'none';
  });

  // register service worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./service-worker.js');
  }

  // wire up accelerometer & gyroscope
  setupSensor('accelerometer', 'Accelerometer', 'devicemotion');
  setupSensor('gyroscope',     'Gyroscope',     'deviceorientation');
  </script>
</body>
</html>
